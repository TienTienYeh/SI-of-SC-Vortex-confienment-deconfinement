<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supplemental Videos — Quantum Printing</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #15171c;
      --accent: #6ee7ff;
      --muted: #a7b0c0;
      --text: #e7edf5;
      --border: #242733;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text); background: radial-gradient(circle at 20% -10%, #141826, #0b0c10);
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display: grid; gap: 8px; margin-bottom: 16px; }
    header h1 { margin: 0; font-size: 1.5rem; letter-spacing: .2px; }
    header p { margin: 0; color: var(--muted); }

    .controls { display: grid; gap: 12px; background: var(--panel); border: 1px solid var(--border); padding: 14px; border-radius: 12px; }
    .filters { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .field { display: grid; gap: 6px; }
    .field label { font-size: .85rem; color: var(--muted); }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 10px; background: #0f1117; border: 1px solid var(--border);
      color: var(--text);
    }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 10px; background: #0f1117;
      color: var(--text); border: 1px solid var(--border); cursor: pointer;
    }
    .btn.primary { background: linear-gradient(180deg, #1d2333, #141a29); border-color: #2a3144; }
    .meta { display: flex; gap: 14px; align-items: center; color: var(--muted); font-size: .9rem; }

    .grid { margin-top: 16px; display: grid; gap: 14px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; overflow: clip; display: grid; }
    .thumb { position: relative; aspect-ratio: 16/9; background: #0f1117; display: grid; place-items: center; }
    .thumb .playhint { position: absolute; bottom: 8px; right: 8px; font-size: .8rem; color: #c9d3e7; background: rgba(20,25,36,.6); padding: 4px 8px; border-radius: 6px; }
    .thumb video, .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .card .body { padding: 12px; display: grid; gap: 8px; }
    .caption { color: var(--text); font-size: .95rem; }
    .small { color: var(--muted); font-size: .82rem; }

    .pagination { margin: 16px 0; display: flex; gap: 8px; justify-content: center; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Supplemental Videos — Quantum Printing</h1>
      <p>Filter by parameters and play inline. Dataset is client-side from <code>metadata.json</code> (one line per video).</p>
    </header>

    <section class="controls">
      <div class="filters" id="filters"><!-- dynamic fields --></div>
      <div class="row">
        <div class="field" style="flex:1 1 260px; min-width:260px;">
          <label for="q">Search (caption, figure, section)</label>
          <input id="q" type="text" placeholder="e.g. deconfinement, Fig.14, B2, skyrmion" />
        </div>
        <button class="btn" id="resetBtn" title="Reset all filters">Reset</button>
        <button class="btn primary" id="copyUrlBtn" title="Copy filters as URL">Copy link with filters</button>
        <span class="meta" id="count">0 results</span>
      </div>
    </section>

    <div class="pagination" id="pagerTop"></div>
    <section class="grid" id="grid"><!-- cards --></section>
    <div class="pagination" id="pagerBottom"></div>
  </div>

  <script>
  // ===== Configuration =====
  const METADATA_URL = 'metadata.json'; // same repo root by default
  const PAGE_SIZE = 24;                 // cards per page

  // ===== State =====
  let DB = [];            // raw items
  let PARAM_KEYS = [];    // discovered param keys
  let FILTERS = {};       // current filter selections
  let QUERY = '';         // text search
  let PAGE = 1;           // current page

  // ===== Utils =====
  const by = (sel, el=document) => el.querySelector(sel);
  const el = (tag, cls, html) => { const n = document.createElement(tag); if (cls) n.className = cls; if (html!==undefined) n.innerHTML = html; return n; };
  const uniq = arr => [...new Set(arr)];
  const escapeHTML = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

  function readQuery() {
    const u = new URL(location.href);
    QUERY = u.searchParams.get('q') || '';
    PAGE = parseInt(u.searchParams.get('page')||'1', 10);
    FILTERS = {};
    PARAM_KEYS.forEach(k => {
      const v = u.searchParams.get(k);
      if (v && v !== 'ANY') FILTERS[k] = v;
    });
  }
  function writeQueryToURL(push=false){
    const u = new URL(location.href);
    u.searchParams.set('page', PAGE);
    if (QUERY) u.searchParams.set('q', QUERY); else u.searchParams.delete('q');
    PARAM_KEYS.forEach(k=>{
      if (FILTERS[k]) u.searchParams.set(k, FILTERS[k]); else u.searchParams.delete(k);
    });
    (push?history.pushState:history.replaceState).call(history, null, '', u.toString());
  }

  // ===== Data load =====
  async function loadDB(){
    try {
      const res = await fetch(METADATA_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error('metadata.json must contain an array');
      // Normalize
      DB = data.map((d,i)=>({
        id: d.id ?? ('vid_'+i),
        url: d.url,
        poster: d.poster || '',
        figure: d.figure || '',
        section: d.section || '',
        caption: d.caption || '',
        params: d.params || {}
      }));
      PARAM_KEYS = uniq(DB.flatMap(d=>Object.keys(d.params))).sort();
    } catch(err){
      console.error(err);
      by('#grid').append(el('div','card',`<div class="body"><div class="caption">Failed to load <code>${escapeHTML(METADATA_URL)}</code> — ${escapeHTML(err.message)}</div></div>`));
    }
  }

  // ===== UI: filters =====
  function buildFilters(){
    const host = by('#filters');
    host.innerHTML = '';
    PARAM_KEYS.forEach(k => {
      const field = el('div','field');
      const lab = el('label', null, escapeHTML(k)); lab.setAttribute('for','f_'+k);
      const sel = el('select'); sel.id = 'f_'+k; sel.dataset.key = k;
      const opts = ['ANY', ...uniq(DB.map(d=>d.params[k]).filter(v=>v!==undefined && v!==null)).sort((a,b)=>String(a).localeCompare(String(b), undefined, {numeric: true}))];
      opts.forEach(v=>{
        const o = el('option'); o.value = v; o.textContent = v; if (!FILTERS[k] && v==='ANY') o.selected = true; if (FILTERS[k] && String(FILTERS[k])===String(v)) o.selected = true; sel.appendChild(o);
      });
      sel.addEventListener('change', ()=>{ const v = sel.value; if (v==='ANY') delete FILTERS[k]; else FILTERS[k]=v; PAGE=1; render(); writeQueryToURL(); });
      field.append(lab, sel); host.append(field);
    });
    // search box sync
    const q = by('#q'); q.value = QUERY; q.addEventListener('input', debounce(()=>{ QUERY = q.value.trim(); PAGE=1; render(); writeQueryToURL(); }, 200));
  }

  // ===== Filtering =====
  function applyFilters(){
    const q = QUERY.toLowerCase();
    return DB.filter(d => {
      // param match
      for (const k of Object.keys(FILTERS)) {
        if (String(d.params[k]) !== String(FILTERS[k])) return false;
      }
      // text search
      if (q) {
        const hay = (d.caption+' '+d.figure+' '+d.section).toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
  }

  // ===== Render grid & pager =====
  function render(){
    const results = applyFilters();
    const total = results.length;
    by('#count').textContent = `${total} result${total===1?'':'s'}`;

    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    PAGE = Math.min(Math.max(1, PAGE), totalPages);
    const start = (PAGE-1)*PAGE_SIZE;
    const slice = results.slice(start, start + PAGE_SIZE);

    const grid = by('#grid');
    grid.innerHTML='';
    slice.forEach(item => grid.append(card(item)));

    renderPager('#pagerTop', totalPages);
    renderPager('#pagerBottom', totalPages);
    setupLazyLoading();
  }

  function renderPager(selector, totalPages){
    const host = by(selector); host.innerHTML='';
    if (totalPages<=1) return;
    const mkBtn=(label, page, disabled=false)=>{
      const b = el('button','btn'); b.textContent = label; b.disabled = disabled; if (!disabled) b.addEventListener('click', ()=>{ PAGE=page; render(); writeQueryToURL(); }); return b;
    };
    host.append(mkBtn('⟨ Prev', Math.max(1, PAGE-1), PAGE===1));
    host.append(el('span','meta',`Page ${PAGE} / ${totalPages}`));
    host.append(mkBtn('Next ⟩', Math.min(totalPages, PAGE+1), PAGE===totalPages));
  }

  function card(d){
    const c = el('article','card');
    const th = el('div','thumb');

    const img = el('img');
    img.alt = 'poster';
    if (d.poster) img.src = d.poster; else img.setAttribute('data-fallback', '1');
    th.append(img);

    const vd = el('video');
    vd.setAttribute('preload','none');
    vd.setAttribute('controls','');
    vd.setAttribute('playsinline','');
    vd.dataset.src = d.url; // lazy attachment
    vd.classList.add('hidden');
    th.append(vd);

    const hint = el('div','playhint','Click to load & play');
    th.append(hint);

    th.addEventListener('click', ()=>{
      if (vd.src) {
        vd.paused ? vd.play() : vd.pause();
        return;
      }
      // first activation: attach source
      vd.src = d.url;
      vd.classList.remove('hidden');
      img.classList.add('hidden');
      hint.textContent = 'Loading…';
      vd.addEventListener('canplay', ()=>{ hint.textContent = 'Playing'; vd.play(); }, { once: true });
    });

    const body = el('div','body');
    const cap = el('div','caption', escapeHTML(d.caption||'(no caption)'));
    const meta = el('div','small', `${escapeHTML(d.figure||'')}${d.figure&&d.section?' · ':''}${escapeHTML(d.section||'')}`);

    // params line
    const paramsStr = Object.entries(d.params).map(([k,v])=>`<code>${escapeHTML(k)}=${escapeHTML(String(v))}</code>`).join(' · ');
    const params = el('div','small', paramsStr);

    // links row
    const links = el('div','row');
    if (d.url) {
      const a = el('a','btn', 'Open video'); a.href = d.url; a.target = '_blank'; links.append(a);
      const b = el('a','btn', 'Download'); b.href = d.url; b.download = ''; links.append(b);
    }
    if (d.poster) { const p = el('a','btn', 'Poster'); p.href = d.poster; p.target = '_blank'; links.append(p); }

    body.append(cap, meta, params, links);
    c.append(th, body);
    return c;
  }

  // Lazy load when video comes into view (attach src if user scrolled to it and already clicked once)
  function setupLazyLoading(){
    const obs = new IntersectionObserver(entries =>{
      entries.forEach(ent =>{
        if (!ent.isIntersecting) return;
        const vd = ent.target.querySelector('video');
        const img = ent.target.querySelector('img');
        const hint = ent.target.querySelector('.playhint');
        // If user hasn't clicked, we still wait to attach on click (to avoid heavy auto loads). Keep IO here in case you want to auto-attach when in view:
        // Example: uncomment next lines to auto-attach when visible
        // if (!vd.src && vd.dataset.src) { vd.src = vd.dataset.src; vd.classList.remove('hidden'); img.classList.add('hidden'); hint.textContent = 'Ready'; }
      });
    }, { rootMargin: '200px' });
    document.querySelectorAll('.thumb').forEach(t => obs.observe(t));
  }

  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,args), ms); } }

  // ===== Init =====
  (async function init(){
    await loadDB();
    readQuery();
    buildFilters();
    // Controls
    by('#resetBtn').addEventListener('click', ()=>{ FILTERS={}; QUERY=''; PAGE=1; buildFilters(); render(); writeQueryToURL(); });
    by('#copyUrlBtn').addEventListener('click', ()=>{ writeQueryToURL(true); navigator.clipboard.writeText(location.href).then(()=>{ by('#copyUrlBtn').textContent='Copied!'; setTimeout(()=>by('#copyUrlBtn').textContent='Copy link with filters', 1200); }); });
    window.addEventListener('popstate', ()=>{ readQuery(); buildFilters(); render(); });
    render();
  })();
  </script>

  <!--
  Sample metadata.json entry for reference:
  [
    {
      "id": "movie_001",
      "url": "videos/movie_001.mp4",
      "poster": "posters/movie_001.jpg",
      "params": {
        "E_over_E0": 1.5,
        "I_over_Ic": 0.53,
        "T_over_Tc": 1.2,
        "geometry": "stripe",
        "mode": "LG l=1 p=0"
      },
      "figure": "Fig.14",
      "section": "B2",
      "caption": "Vortex deconfinement at [I/Ic,E/E0]=[0.53,1.5], T/Tc=1.2."
    }
  ]
  -->
</body>
</html>
